var BrickyEditor=function(t){"use strict";var n=function(t,e){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])})(t,e)};function e(t,e){function o(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(o.prototype=e.prototype,new o)}function f(r,l,s,a){return new(s=s||Promise)(function(t,e){function o(t){try{i(a.next(t))}catch(t){e(t)}}function n(t){try{i(a.throw(t))}catch(t){e(t)}}function i(e){e.done?t(e.value):new s(function(t){t(e.value)}).then(o,n)}i((a=a.apply(r,l||[])).next())})}function m(o,n){var i,r,l,t,s={label:0,sent:function(){if(1&l[0])throw l[1];return l[1]},trys:[],ops:[]};return t={next:e(0),throw:e(1),return:e(2)},"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function e(e){return function(t){return function(e){if(i)throw new TypeError("Generator is already executing.");for(;s;)try{if(i=1,r&&(l=2&e[0]?r.return:e[0]?r.throw||((l=r.return)&&l.call(r),0):r.next)&&!(l=l.call(r,e[1])).done)return l;switch(r=0,l&&(e=[2&e[0],l.value]),e[0]){case 0:case 1:l=e;break;case 4:return s.label++,{value:e[1],done:!1};case 5:s.label++,r=e[1],e=[0];continue;case 7:e=s.ops.pop(),s.trys.pop();continue;default:if(!(l=0<(l=s.trys).length&&l[l.length-1])&&(6===e[0]||2===e[0])){s=0;continue}if(3===e[0]&&(!l||e[1]>l[0]&&e[1]<l[3])){s.label=e[1];break}if(6===e[0]&&s.label<l[1]){s.label=l[1],l=e;break}if(l&&s.label<l[2]){s.label=l[2],s.ops.push(e);break}l[2]&&s.ops.pop(),s.trys.pop();continue}e=n.call(o,s)}catch(t){e=[6,t],r=0}finally{i=l=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}([e,t])}}}var g=(r.el=function(t){var e=document.createElement("div");e.innerHTML=t;var o=e.firstElementChild;return e.innerHTML=null,o},r.ons=function(e,t,o){var n=this;t.split(" ").forEach(function(t){n.on(e,t,o)})},r.on=function(t,e,o){return t.attachEvent?t.attachEvent("on"+e,o):t.addEventListener(e,o,!1)},r.offset=function(t){var e=t.getBoundingClientRect(),o=document.body;return{top:e.top+o.scrollTop,left:e.left+o.scrollLeft}},r.wrap=function(t,e){t.parentElement.insertBefore(e,t),e.appendChild(t)},r.unwrap=function(t){if(t.parentElement){var e=t.parentElement.parentElement;e?e.replaceChild(t,t.parentElement):t.parentElement.innerHTML=t.innerHTML}},r.hide=function(t){t.style.display="none"},r.show=function(t){t.style.display="block"},r.isHidden=function(t){return"none"===window.getComputedStyle(t).display},r.toggle=function(t,e){(e?e.valueOf():this.isHidden(t))?this.show(t):this.hide(t)},r.before=function(e,t){var o=this;t instanceof HTMLElement?e.parentNode.insertBefore(t,e):t.forEach(function(t){return o.before(e,t)})},r.after=function(t,e){t.nextSibling?t.parentNode.insertBefore(e,t):t.parentNode.appendChild(e)},r.hasClass=function(t,e){t.classList?t.classList.contains(e):new RegExp("(^| )"+e+"( |$)","gi").test(t.className)},r.addClass=function(t,e){this.hasClass(t,e)||(t.classList?t.classList.add(e):t.className+=" "+e)},r.removeClass=function(t,e){t.classList?t.classList.remove(e):t.className=t.className.replace(new RegExp("(^|\\b)"+e.split(" ").join("|")+"(\\b|$)","gi")," ")},r.toggleClass=function(t,e,o){if(o)o.valueOf()?this.addClass(t,e):this.removeClass(t,e);else if(t.classList)t.classList.toggle(e);else{for(var n=t.className.split(" "),i=-1,r=n.length;r--;)n[r]===e&&(i=r);0<=i?n.splice(i,1):n.push(e),t.className=n.join(" ")}},r.windowScrollTop=function(){return void 0!==window.pageYOffset?window.pageYOffset:(document.documentElement||document.body.parentNode||document.body).scrollTop},r.replaceWith=function(t,e){var o=t.parentElement;o&&o.replaceChild(e,t)},r.select=function(t,e,o){void 0===o&&(o=!1);var n=t.querySelectorAll(e),i=Array.prototype.slice.call(n);return o&&o.valueOf()&&r.matches(t,e)&&i.push(t),i},r.find=function(t){return document.querySelector(t)},r.first=function(t,e){return t.querySelector(e)},r.clone=function(t){return t.cloneNode(!0)},r.trigger=function(t,e,o){if(window.CustomEvent)var n=new CustomEvent(e,{detail:o});else(n=document.createEvent("CustomEvent")).initCustomEvent(e,!0,!0,o);t.dispatchEvent(n)},r.matches=function(t,e){return(t.matches||t.matchesSelector||t.msMatchesSelector||t.mozMatchesSelector||t.webkitMatchesSelector||t.oMatchesSelector).call(t,e)},r.data=function(t,e){var o=t.dataset[e],n=null;try{n=JSON.parse(o)}catch(t){if(t instanceof SyntaxError){o=o.replace(/'/g,'"');try{n=JSON.parse(o)}catch(t){}}}return n},r);function r(){}var v=(o.get=function(n){return new Promise(function(t,o){var e=new XMLHttpRequest;e.open("GET",n,!0),e.onreadystatechange=function(){if(4===this.readyState)if(200<=this.status&&this.status<400){var e=null;try{e=JSON.parse(this.responseText)}catch(t){e=this.responseText}try{t(e)}catch(t){o(t)}}else o()},e.send(),e=null})},o.getScript=function(r){return new Promise(function(t,e){function o(){i||this.readyState&&"loaded"!=this.readyState&&"complete"!=this.readyState?e():(i=!0,t())}var n=document.createElement("script"),i=!1;n.onload=o,n.onreadystatechange=o,n.src=r,document.getElementsByTagName("head")[0].appendChild(n)})},o.jsonp=function(l){return new Promise(function(o,t){var n="_"+Math.round(1e4*Math.random()),i="jsonp_callback_"+n;window[i]=function(t){delete window[i];var e=document.getElementById(n);e.parentNode.removeChild(e),o(t)};var e=l+"&callback="+i,r=document.createElement("script");r.src=e,r.id=n,r.addEventListener("error",t),(document.getElementsByTagName("head")[0]||document.body||document.documentElement).appendChild(r)})},o);function o(){}var b=(i.attr=function(t){return"["+t+"]"},i.attrContentEditable="contenteditable",i.selectorContentEditable="contenteditable",i.selectorField="["+(i.attrField="data-bre-field")+"]",i.classEditor="bre-editor",i.selectorTemplate="."+(i.classTemplate="bre-template"),i.selectorTemplateGroup="."+(i.classTemplateGroup="bre-template-group"),i.selectorTemplatePreview=".bre-template-preview",i.classMobile="brickyeditor-tools-mobile",i.htmlToolsCommand="data-bre-doc-command",i.htmlToolsCommandRange="data-bre-doc-command-range",i.selectorFieldSelected="bre-field-selected",i.selectorFieldContainer="bre-field-container",i.selectorHtmlToolsCommand=i.attr(i.htmlToolsCommand),i.selectorHtmlToolsCommandRange=i.attr(i.htmlToolsCommandRange),i);function i(){}var l=function(t,e,o){this.icon=t,this.action=e,this.title=o};String.prototype.breContains=function(t){return 0<=this.indexOf(t)},String.prototype.breStartsWith=function(t){return 0==this.indexOf(t)},String.prototype.breTotalTrim=function(){return this?this.replace(/\s\s+/g," ").trim():""},String.prototype.breEqualsInvariant=function(t){return this.toLowerCase()===t.toLowerCase()},Array.prototype.find||(Array.prototype.find=function(t){if(null==this)throw new TypeError("Array.prototype.find called on null or undefined");if("function"!=typeof t)throw new TypeError("predicate must be a function");for(var e,o=Object(this),n=o.length>>>0,i=arguments[1],r=0;r<n;r++)if(e=o[r],t.call(i,e,r,o))return e});var d=(s.extend=function(t){for(var e=[],o=1;o<arguments.length;o++)e[o-1]=arguments[o];t=t||{};for(var n=1;n<e.length;n++)if(e[n])for(var i in e[n])e[n].hasOwnProperty(i)&&(t[i]=e[n][i]);return t},s.getSelectedText=function(){var t="",e=document;return window.getSelection?t=window.getSelection().toString():e.selection&&"Control"!=e.selection.type&&(t=e.selection.createRange().text),t},s.propsEach=function(t,e){for(var o in t)t.hasOwnProperty(o)&&e(o,t[o])},s.propsFilterKeys=function(t,o,e){var n=[];return s.propsEach(t,function(t,e){o(t,e)&&n.push(t)}),e&&n.push(e),n},s);function s(){}var a=(Object.defineProperty(u,"type",{get:function(){var t=this.name;return t=(t=t.replace("Field","")).substring(0,1).toLowerCase()+t.substring(1)},enumerable:!0,configurable:!0}),u.prototype.getSettingsEl=function(){return null},u.registerCommonFields=function(){this.commonFieldsRegistered||(J.registerField(),Q.registerField(),V.registerField(),h.registerField()),this.commonFieldsRegistered=!0},u.registerField=function(){this._fields.hasOwnProperty(this.type)&&delete this._fields[this.type],this._fields[this.type]=this},u.createField=function(t,e,o,n,i){var r=g.data(t,"breField");if(!r||!r.name)throw"There is no data or data doesn't contains 'name' in field "+t.innerHTML;if(e){for(var l={},s=0;s<e.length;s++)if((a=e[s]).name.toLowerCase()===r.name.toLowerCase()){l=a;break}l&&(r=d.extend(r,l))}var a,c=r.type;if(null==c)throw"Field type not defined in data-bre-field attribute";if(u.commonFieldsRegistered||u.registerCommonFields(),this._fields.hasOwnProperty(c))return new(a=this._fields[c])(t,r,o,n,i);throw c+" field not found"},u.prototype.bind=function(){},u.prototype.select=function(){this.$field.classList.add(b.selectorFieldSelected),this.onSelect(this)},u.prototype.deselect=function(){this.$field.classList.remove(b.selectorFieldSelected)},u.prototype.getEl=function(){var t=this.$field.cloneNode(!0);return t.attributes.removeNamedItem(b.attrField),t},u.prototype.updateProperty=function(t,e,o){void 0===o&&(o=!0);var n=this.data[t];n!==e&&(this.data[t]=e,o&&this.onUpdate(t,n,e))},u._fields={},u.commonFieldsRegistered=!1,u);function u(t,e,o,n,i){this.$field=t,this.data=e,this.onSelect=o,this.onUpdate=n,this.onUpload=i,this.bind()}var c,h=(e(p,c=a),p.prototype.bind=function(){var e=this,o=this,t=this.$field;this.container=new dt(t,function(t){o.updateBlocks()},function(t){o.updateBlocks()},function(t){e.select()},function(t){},function(t){o.updateBlocks()},function(t){o.updateBlocks()},o.onUpload,!0),g.addClass(t,b.selectorFieldContainer),g.on(t,"click",function(t){return o.select(),t.stopPropagation(),!1})},p.prototype.updateBlocks=function(){this.updateProperty("blocks",this.container.getData(!0),!0),this.updateProperty("html",this.container.getHtml(),!0)},p.prototype.deselect=function(){this.container.blocks.forEach(function(t){return t.deselect()}),this.$field.classList.remove(b.selectorFieldSelected)},p.prototype.getEl=function(){var t=this.container.getHtml();return g.el(t)},p);function p(){return null!==c&&c.apply(this,arguments)||this}var y=(k.errorBlocksFileNotFound=function(t){return"Blocks file not found. Requested file: "+t+"."},k.errorTemplatesFileNotFound=function(t){return"Templates file not found. Requested file: "+t+"."},k.errorBlockTemplateNotFound=function(t){return'Template "'+t+'" not found.'},k.errorTemplateParsing=function(t){return"Template parsing error: "+t+"."},k.embedFieldLinkTitle="Link to embed media",k.embedFieldLinkPlaceholder="Link to instagram, youtube and etc.",k.imageFieldLinkTitle="Image link",k.imageFieldLinkPlaceholder="http://url-to-image.png",k.imageFieldUploadTitle="or Upload a file",k.imageFieldUploadButton="Select file",k.imageFieldAltTitle="Alt",k.imageFieldAltPlaceholder="Image 'alt' attribute value",k.imageFieldUrlSubtitle="Link to open on image click",k.htmlEditorLinkUrlTitle="Url",k.htmlEditorLinkUrlPlaceholder="http://put-your-link.here",k.htmlEditorLinkTitleTitle="Title",k.htmlEditorLinkTitlePlaceholder="Title attribute for link",k.htmlEditorLinkTargetTitle="Target",k.htmlEditorLinkTargetBlank="Blank",k.htmlEditorLinkTargetSelf="Self",k.htmlEditorLinkTargetParent="Parent",k.htmlEditorLinkTargetTop="Top",k.buttonClose="close",k.buttonOk="Ok",k.buttonCancel="Cancel",k.defaultTemplatesGroupName="Other templates",k);function k(){}var w=($.prototype.parseValue=function(){this.$input&&(this.value=this.$input.value),this.$control=null,delete this._$control},Object.defineProperty($.prototype,"$control",{get:function(){return this._$control||(this._$control=g.el("<div class="+(this.key?"bre-prompt-field":"bre-prompt-subtitle")+'>\n                            <label class="bre-label" for="'+this.key+'">'+(this.title?this.title:"Select file...")+"</label>\n                        </div>"),this.$input=this.key?this.getEditor():null,null!=this.$input&&this._$control.appendChild(this.$input)),this._$control},set:function(t){this._$control=t},enumerable:!0,configurable:!0}),$.prototype.getEditor=function(){var t=document.createElement("input");return t.id=this.key,t.className="bre-input",t.setAttribute("type","text"),t.setAttribute("placeholder",this.placeholder),t.value=this.value||"",t},$);function $(t,e,o,n){this.key=t,this.title=e,this.placeholder=n||"",this.value=o}var T,E=(e(C,T=w),C.prototype.parseValue=function(){this.value=this._value,this.$control=null,delete this._$control,this._value=null,delete this._value},C.prototype.getEditor=function(){var o=this,t=this.value&&this.value.fileContent?this.value.fileContent:"",e=g.el("\n                <div class='bre-image-input'>\n                    <label for=\""+this.key+'">\n                        '+this.placeholder+'\n                    </label>                        \n                    <img src="'+t+'"/>                    \n                    <input type="file" id="'+this.key+'" class="bre-input" placeholder="'+this.placeholder+"\">\n                </div>\n                <small class='bre-image-input-filename'></small>"),n=e.querySelector("input"),i=e.querySelector("img"),r=e.querySelector(".bre-image-input-filename");return this.value,o.updatePreview(i,r,this.value),n.onchange=function(){if(n.files&&n.files[0]){var t=new FileReader;t.onload=function(t){var e=t.target;o._value=new B,o._value.fileContent=e.result,o._value.fileInfo=new L(n.files[0]),o.updatePreview(i,r,o._value)},t.readAsDataURL(n.files[0])}},e},C.prototype.updatePreview=function(t,e,o){o&&(t.src=o.fileContent,t.classList.add("bre-loaded"),e.innerText=o.fileInfo.name)},C);function C(t,e,o,n){var i=T.call(this,t,e,o,n)||this;return o&&(i._value=o),i}var B=function(){},L=function(t){this.name=t.name,this.size=t.size,this.type=t.type,this.lastModified=t.lastModified,this.lastModifiedDate=t.lastModifiedDate},S=(P.prototype.getValue=function(e){var t=this.params.find(function(t){return t.key===e});return t?t.value:null},P);function P(t){this.params=t}var F,A=function(t,e,o){void 0===o&&(o=!1),this.title=t,this.value=e,this.selected=o},U=(e(M,F=w),M.prototype.getEditor=function(){var t=this.options.map(function(t){return'<option value="'+t.value+'" '+(t.selected?"selected":"")+">"+(t.title?t.title:t.value)+"</option>"});return g.el('<select type="text" id="'+this.key+'" class="brickyeditor-input" placeholder="'+this.placeholder+'">'+t+"</select>")},M);function M(t,e,o,n,i){var r=F.call(this,t,e,n,i)||this;return r.options=[],o.forEach(function(t){r.options.push(new A(t[0],t[1],t[1]==n))}),r}var H=(N.getEmbedAsync=function(t){var e=this,r="https://noembed.com/embed?url="+t;return new Promise(function(n,i){return f(e,void 0,void 0,function(){var e,o;return m(this,function(t){switch(t.label){case 0:return t.trys.push([0,2,,3]),[4,v.jsonp(r)];case 1:return e=t.sent(),n(e),[3,3];case 2:return o=t.sent(),i(o),[3,3];case 3:return[2]}})})})},N.processEmbed=function(t){switch(t){case N.Instagram:instgrm&&instgrm.Embeds.process()}},N.Instagram="Instagram",N);function N(){}var I=(x.prototype.getPreview=function(){var t=g.el("<div class='"+b.classTemplate+"'></div>");return t.appendChild(this.$preview),t},x);function x(t){if(this.loaded=!0,this.name=t.dataset.name,this.$preview=g.first(t,b.selectorTemplatePreview),this.$preview&&t.removeChild(this.$preview),this.$html=t,!this.$preview){var e=new at(this,!0).getHtml(!0);null===e?this.loaded=!1:this.$preview=g.el(e)}}var D=function(t,e){this.name=t,this.templates=e},O=(_.loadTemplatesAsync=function(u,h,p){return f(this,void 0,Promise,function(){var e=this;return m(this,function(t){return this.templates=[],this.templates,[2,new Promise(function(c,d){return f(e,void 0,void 0,function(){var e,o,n,i,r,l,s,a=this;return m(this,function(t){switch(t.label){case 0:return t.trys.push([0,2,,3]),[4,v.get(u)];case 1:return e=t.sent(),o=g.el("<div>"+e+"</div>"),0<(n=g.select(o,"style",!1)).length&&g.before(h,n),g.select(o,b.selectorTemplateGroup).forEach(function(t){var e=t.getAttribute("title"),o=a.getTemplates(t,p);a.templates.push(new D(e,o)),t.remove()}),i=this.getTemplates(o,p),r=0<this.templates.length?y.defaultTemplatesGroupName:"",l=new D(r,i),this.templates.push(l),c(this.templates),[3,3];case 2:return s=t.sent(),p(y.errorTemplatesFileNotFound(u)),d(s),[3,3];case 3:return[2]}})})})]})})},_.getTemplates=function(t,o){var n=[];return g.select(t,b.selectorTemplate).forEach(function(t){var e=new I(t);e.loaded?n.push(e):o(y.errorTemplateParsing(e.name))}),n},_.getTemplate=function(t){for(var e=0;e<this.templates.length;e++)for(var o=this.templates[e],n=0;n<o.templates.length;n++){var i=o.templates[n];if(i.name.breEqualsInvariant(t))return i}return null},_);function _(){}var R,V=(e(j,R=a),j.prototype.getSettingsEl=function(){var t=g.el('<div style="position: absolute;width: 100%; height: 100px;;text-align: center;font-weight: bold;vertical-align: middle;background: #333;opacity: 0.2;">Change embed element link</div>');return g.before(this.$field,t),t},Object.defineProperty(j.prototype,"settings",{get:function(){var e=this;return function(t){e.showEmbedLoaderAsync(t)}},enumerable:!0,configurable:!0}),j.prototype.bind=function(){var t=this,e=this,o=this.$field;g.on(o,"click",function(){return f(t,void 0,void 0,function(){return m(this,function(t){return this.showEmbedLoaderAsync(e),[2]})})}),e.loadMedia(!1)},j.prototype.showEmbedLoaderAsync=function(n){return f(this,void 0,void 0,function(){var e,o;return m(this,function(t){switch(t.label){case 0:return[4,mt.UI.modal.promptAsync(n.getPromptParams())];case 1:return null==(e=t.sent())?[3,3]:(o=e.getValue("url"))?(n.setUrl(o),[4,n.loadMedia(!0)]):[3,3];case 2:t.sent(),t.label=3;case 3:return[2]}})})},j.prototype.getPromptParams=function(){return[new w("url",y.embedFieldLinkTitle,this.data.url||"http://instagr.am/p/BO9VX2Vj4fF/",y.embedFieldLinkPlaceholder)]},j.prototype.loadMedia=function(l){return f(this,void 0,void 0,function(){var e,o,n,i,r;return m(this,function(t){switch(t.label){case 0:return(e=this).data&&e.data.url?[4,H.getEmbedAsync(e.data.url)]:[2];case 1:return o=t.sent(),e.setEmbed(o,l),n=g.el(o.html),(i=g.first(n,"script"))&&(i.remove(),(r=i.src).breStartsWith("//")&&(r="https:"+r,v.getScript(r).then(function(){H.processEmbed(o.provider_name)}))),e.$field.innerHTML="",e.$field.removeAttribute("class"),e.$field.removeAttribute("style"),e.$field.appendChild(n),e.select(),[2]}})})},j.prototype.setEmbed=function(t,e){void 0===e&&(e=!0),this.updateProperty("embed",t,e)},j.prototype.setUrl=function(t){this.updateProperty("url",t)},j);function j(){return null!==R&&R.apply(this,arguments)||this}var q=(W.bindTextSelection=function(t,o){var n=this;g.matches(t,"[contenteditable]")&&(g.on(t,"mouseup",function(){setTimeout(function(){var t=n.getSelectionRect();o(t)},0)}),g.on(t,"keyup",function(t){var e=n.getSelectionRect();o(e)}))},W.getSelectionRect=function(){var t=window.getSelection().getRangeAt(0);if(t){var e=t.getBoundingClientRect();if(e)return e}return null},W);function W(){}var G,J=(e(z,G=a),z.prototype.bind=function(){var e=this,o=this,n=this.$field;g.matches(n,b.selectorContentEditable)||n.setAttribute(b.attrContentEditable,"true");var t=this.data.html||this.$field.innerHTML;this.setHtml(t,!1),n.innerHTML=this.data.html,q.bindTextSelection(n,function(t){mt.UI.htmlTools.show(t)}),g.ons(n,"blur keyup paste input",function(t){e.setHtml(n.innerHTML)}),g.on(n,"paste",function(t){t.preventDefault();var e=t.originalEvent.clipboardData.getData("text/plain");document.execCommand("insertHTML",!1,e)}),g.on(n,"click",function(t){return o.select(),t.stopPropagation(),!1})},z.prototype.setHtml=function(t,e){void 0===e&&(e=!0),t=t.trim(),this.$field.innerHTML!==t&&(this.$field.innerHTML=t),this.updateProperty("html",t,e)},z.prototype.getEl=function(){var t=G.prototype.getEl.call(this);return t.removeAttribute(b.attrContentEditable),t},z);function z(){return null!==G&&G.apply(this,arguments)||this}var X=(Y.prototype.getLinkPromptParams=function(){return[new w("href",y.htmlEditorLinkUrlTitle,this.href,y.htmlEditorLinkUrlPlaceholder),new w("title",y.htmlEditorLinkTitleTitle,this.title,y.htmlEditorLinkTitlePlaceholder),new U("target",y.htmlEditorLinkTargetTitle,[["",""],[y.htmlEditorLinkTargetBlank,"_blank"],[y.htmlEditorLinkTargetSelf,"_self"],[y.htmlEditorLinkTargetParent,"_parent"],[y.htmlEditorLinkTargetTop,"_top"]],this.target)]},Y.getLinkFromParams=function(t){return new Y(t.getValue("href"),t.getValue("title"),t.getValue("target"))},Y);function Y(t,e,o){void 0===t&&(t=""),void 0===e&&(e=""),void 0===o&&(o=""),this.href=t,this.title=e,this.target=o}var K,Q=(e(Z,K=a),Z.prototype.bind=function(){var t=this,l=this;this.data,this.setSrc(this.data.src,!1),g.on(this.$field,"click",function(){return f(t,void 0,void 0,function(){var e,o,n,i,r;return m(this,function(t){switch(t.label){case 0:return[4,mt.UI.modal.promptAsync(l.getPromptParams())];case 1:return null!=(e=t.sent())&&(o=e.getValue("file"),n=e.getValue("src"),o?l.onUpload?l.onUpload(o,function(t){l.setSrc(t),l.setFile(null)}):(l.setFile(o),l.setSrc(null)):n&&(l.setSrc(n),l.setFile(null)),i=e.getValue("alt"),l.setAlt(i),r=X.getLinkFromParams(e),this.setLink(r)),l.select(),[2]}})})})},Z.prototype.getPromptParams=function(){var t=[new w("src",y.imageFieldLinkTitle,this.data.url,y.imageFieldLinkPlaceholder),new E("file",y.imageFieldUploadTitle,this.data.file,y.imageFieldUploadButton),new w("alt",y.imageFieldAltTitle,this.data.alt,y.imageFieldAltPlaceholder),new w(null,y.imageFieldUrlSubtitle,null,null)],e=(this.data.link?this.data.link:new X).getLinkPromptParams();return t.concat(e)},Z.prototype.setSrc=function(t,e){void 0===e&&(e=!0),t&&(this.isImg?this.$field.setAttribute("src",t):this.$field.style.backgroundImage="url("+t),this.updateProperty("src",t,e)},Z.prototype.setAlt=function(t){this.$field.setAttribute(this.isImg?"alt":"title",t),this.updateProperty("alt",t)},Z.prototype.setFile=function(t){t&&(this.isImg?this.$field.setAttribute("src",t.fileContent):this.$field.style.backgroundImage="url("+t.fileContent+")"),this.updateProperty("file",t)},Z.prototype.setLink=function(t){t&&t.href?this.$link?this.$link.href=t.href:(this.$link=g.el("<a href='"+t.href+"' title='"+t.title+"' target='"+t.target+"'></a>"),g.on(this.$link,"click",function(t){return t.stopPropagation(),!1}),g.wrap(this.$field,this.$link)):this.$link&&(g.unwrap(this.$field),this.$link=null,delete this.$link),this.updateProperty("link",t)},Object.defineProperty(Z.prototype,"isImg",{get:function(){return this._isImg=this._isImg||"img"===this.$field.tagName.toLowerCase()},enumerable:!0,configurable:!0}),Z.prototype.getEl=function(){var t=K.prototype.getEl.call(this),e=this.data.link;if(e&&e.href){var o=g.el("<a href='"+e.href+"' title='"+e.title+"' target='"+e.target+"'></a>");return o.appendChild(t),o}return t},Z);function Z(){return null!==K&&K.apply(this,arguments)||this}var tt=(et.prototype.setControl=function(){var o=this,n=g.el('<div class="bre-html-tools-panel"></div>');this.buttons.forEach(function(t){var e=o.getButtonElement(t.icon,t.command,t.range,t.aValueArgument);n.appendChild(e)}),this.$control=g.el('<div class="bre-html-tools bre-btn-group"></div>'),this.$control.appendChild(n),g.hide(this.$control),this.editor.$editor.appendChild(this.$control)},et.prototype.getButtonElement=function(t,s,a,c){var e=this;void 0===a&&(a=!0),void 0===c&&(c=null);var o=g.el('<button type="button" class="bre-btn"><i class="fa fa-'+t+'"></i></button>');return o.onclick=function(){return f(e,void 0,void 0,function(){var e,o,n,i,r,l;return m(this,function(t){switch(t.label){case 0:return e=window.getSelection(),o=0<e.rangeCount?e.getRangeAt(0):null,a&&!o?[2]:"CreateLink"!=s?[3,2]:(n=this.getLinkPromptParamsInternal(e),[4,mt.UI.modal.promptAsync(n)]);case 1:return i=t.sent(),(r=X.getLinkFromParams(i)).href&&(document.execCommand(s,!1,r.href),r.target&&e.anchorNode.parentElement.setAttribute("target",r.target),r.title&&e.anchorNode.parentElement.setAttribute("title",r.title)),[3,3];case 2:"string"==typeof c&&(l=c.replace("%%SELECTION%%",e.toString()));try{document.execCommand(s,!1,l)}catch(t){this.wrapSelectionToContainer(e),document.execCommand(s,!1,l)}t.label=3;case 3:return[2,!1]}})})},o},et.prototype.wrapSelectionToContainer=function(t){var e=t.anchorNode.parentElement,o=g.el('<div class="bre-temp-container" contenteditable="true">'+e.innerHTML+"</div>");e.innerHTML="",e.removeAttribute(b.attrContentEditable),e.appendChild(o);var n=document.createRange();n.selectNodeContents(o),t.removeAllRanges(),t.addRange(n)},et.prototype.show=function(t){if(t&&1<t.width){var e=this.editor.$editor,o=g.offset(e),n=e.clientWidth,i=t.top-o.top+g.windowScrollTop()+t.height,r=this.$control.clientWidth,l=t.left-o.left+t.width/2-r/2;l<0?l=0:n<l+r&&(l=n-r),this.$control.style.top=i+"px",this.$control.style.left=l+"px",g.show(this.$control)}else g.hide(this.$control)},et.prototype.getLinkPromptParamsInternal=function(t){var e;if(t&&t.anchorNode&&t.anchorNode.parentNode.nodeName.breEqualsInvariant("a")){var o=t.anchorNode.parentNode;e=new X(o.getAttribute("href"),o.getAttribute("title"),o.getAttribute("target"))}else e=new X;return e.getLinkPromptParams()},et);function et(t){this.editor=t,this.buttons=[{icon:"bold",command:"Bold",range:!0,aValueArgument:null},{icon:"italic",command:"Italic",range:!0,aValueArgument:null},{icon:"link",command:"CreateLink",range:!0,aValueArgument:null},{icon:"list-ul",command:"insertUnorderedList",range:!0,aValueArgument:null},{icon:"list-ol",command:"insertOrderedList",range:!0,aValueArgument:null},{icon:"undo",command:"Undo",range:!1,aValueArgument:null},{icon:"repeat",command:"Redo",range:!1,aValueArgument:null}],t.options.htmlToolsButtons&&(this.buttons=t.options.htmlToolsButtons),this.setControl()}var ot=(nt.prototype.hideModal=function(){this.restoreSelection(),g.hide(this.$control)},nt.prototype.showModal=function(t,e){void 0===e&&(e=!0),this.saveSelection(),g.toggle(this.$btns,e),t&&(this.$form.appendChild(t),g.isHidden(t)&&g.show(t)),g.show(this.$control)},nt.prototype.promptAsync=function(i){var r=this,l=this;return new Promise(function(e,t){for(var o=0;o<l.$form.children.length;o++){var n=l.$form.children[o];n!=r.$btns&&l.$form.removeChild(n)}i.forEach(function(t){g.before(r.$btns,t.$control)}),g.on(l.$okBtn,"click",function(){i.forEach(function(t){return t.parseValue()}),l.hideModal();var t=new S(i);e(t)}),g.on(l.$cancelBtn,"click",function(){l.hideModal(),e(null)}),l.showModal()})},nt.prototype.saveSelection=function(){var t=window.getSelection();this.selectionRanges=[];for(var e=0;e<t.rangeCount;e++)this.selectionRanges.push(t.getRangeAt(e))},nt.prototype.restoreSelection=function(){if(this.selectionRanges&&0!=this.selectionRanges.length){var e=window.getSelection();e.removeAllRanges(),this.selectionRanges.forEach(function(t){return e.addRange(t)})}},nt);function nt(t,e,o,n,i,r){this.$control=t,this.$closeBtn=e,this.$form=o,this.$btns=n,this.$okBtn=i,this.$cancelBtn=r;var l=this;g.on(e,"click",function(){l.hideModal()})}var it=(Object.defineProperty(rt.prototype,"isCompactTools",{get:function(){var t=this.editor.options.compactTools;return null==t?window.innerWidth<this.editor.options.compactToolsWidth:t.valueOf()},enumerable:!0,configurable:!0}),rt.prototype.setTools=function(){var e=this;this.$tools=g.el('<div class="bre bre-tools" data-bricky-tools></div>'),this.$toolsTemplates=g.el('<div class="bre-tools-templates"></div>'),this.$toolsLoader=g.el('<div class="bre-tools-loader"><b>Loading...</b></div>'),this.$toolsHideBtn=g.el('<button type="button" class="bre-tools-toggle"><div>►</div></button>'),this.$tools.appendChild(this.$toolsHideBtn),this.$tools.appendChild(this.$toolsLoader),this.$tools.appendChild(this.$toolsTemplates),this.$toolsHideBtn.onclick=function(t){return e.toggleTools()},this.editor.$editor.appendChild(this.$tools),this.isCompactTools&&(g.addClass(this.$tools,"bre-tools-templates-compact"),this.toggleTools())},rt.prototype.toggleTools=function(){g.toggleClass(this.$tools,"bre-tools-collapsed",!g.hasClass(this.$toolsHideBtn,"bre-tools-toggle-collapsed")),g.toggleClass(this.$toolsHideBtn,"bre-tools-toggle-collapsed")},rt.prototype.setModal=function(){var t=g.el('<div class="bre bre-modal"><div class="bre-modal-placeholder"></div></div>'),e=g.el('<div class="bre-modal-close"><a href="#">'+y.buttonClose+" ✖</a></div>"),o=g.el('<div class="bre-modal-content"></div>'),n=g.el("<form></form>"),i=g.el('<div class="bre-btns"></div>'),r=g.el('<button type="button" class="bre-btn bre-btn-primary">'+y.buttonOk+"</button>"),l=g.el('<button type="button" class="bre-btn">'+y.buttonCancel+"</button>");i.appendChild(r),i.appendChild(l),n.appendChild(i),o.appendChild(n);var s=g.first(t,".bre-modal-placeholder");s.appendChild(e),s.appendChild(o),this.modal=new ot(t,e,n,i,r,l),this.editor.$editor.appendChild(t)},rt.prototype.toggleToolsLoader=function(t){g.toggle(this.$toolsLoader,t)},rt.prototype.setTemplates=function(t){var n=this,i=this.editor;t.forEach(function(t){if(0!==t.templates.length){var e=g.el("<div class='"+b.classTemplateGroup+"'>"+t.name+"</div>");n.$toolsTemplates.appendChild(e);var o=g.el("<div></div>");t.templates.forEach(function(e){var t=e.getPreview();t.setAttribute("title",e.name),t.onclick=function(t){return i.addBlock(e),t.stopPropagation(),!1},o.appendChild(t)}),g.on(e,"click",function(){g.toggle(o)}),n.$toolsTemplates.appendChild(o)}})},rt.initBtnDeck=function(e){var t=g.select(e,".bre-btn")[0];g.on(t,"click",function(t){return rt.toggleBtnDeck(e),t.stopPropagation(),!1})},rt.toggleBtnDeck=function(t,e){var o=g.select(t,".bre-btn");if(o&&0!=o.length){var n=o[0];(e=e||t.dataset.isOn||!1)?(t.style.height="0",t.style.width="0",o.forEach(function(t,e){0!==e&&(t.style.opacity="0",t.style.top="0",t.style.left="0")})):(o.forEach(function(t,e){0!==e&&(t.style.opacity="1",t.style.left=(e+1)*(32+32/6)+"px")}),t.style.height="32px",t.style.width=(32+32/6)*o.length-32/6+"px"),g.toggleClass(n,"bre-btn-active",!e),t.dataset.isOn=String(!e)}},rt);function rt(t){this.editor=t,this.editor=t,this.setTools(),this.setModal(),this.htmlTools=new tt(this.editor)}var lt=(st.prototype.delete=function(){this.$editor.remove()},st.prototype.toggleSelection=function(t){this.$editor.classList.toggle("bre-selected",t)},st.prototype.buildEditorUI=function(t){var o=this;this.$tools=g.el('<div class="bre-block-tools bre-btn-deck"></div>'),t.forEach(function(t){var e=o.buildButton(t);o.$tools.appendChild(e)}),it.initBtnDeck(this.$tools),this.$editor=g.el('<div class="bre-block-wrapper"></div>'),this.$editor.appendChild(this.$tools),this.$editor.appendChild(this.$block),g.on(this.$editor,"mouseover",function(){o.$editor.classList.add("bre-active")}),g.on(this.$editor,"mouseout",function(){o.$editor.classList.remove("bre-active")}),g.on(this.$editor,"click",function(){o.onSelect()})},st.prototype.buildButton=function(e){var t=g.el('<button type="button" class="bre-btn"><i class="fa fa-'+e.icon+'"></i></button>');return e.action&&(t.onclick=function(t){return e.action(),t.stopPropagation(),!1}),t},st);function st(t,e,o,n){this.$block=t,this.onSelect=n,e||this.buildEditorUI(o)}var at=(ct.prototype.isContainer=function(){return!!this.selectedField&&this.selectedField instanceof h},ct.prototype.bindFields=function(t,o){var n=this;g.select(t,b.selectorField,!0).forEach(function(t){var e=a.createField(t,o,function(t){n.select(t)},function(t,e,o){n.onUpdate&&n.onUpdate(n,t,e,o)},n.onUpload);n.fields.push(e)})},ct.prototype.getActions=function(){var t=this;return[new l("ellipsis-h"),new l("trash-o",function(){return t.delete()}),new l("copy",function(){return t.clone()}),new l("angle-up",function(){return t.move(-1)}),new l("angle-down",function(){return t.move(1)})]},ct.prototype.delete=function(){this.ui.delete(),this.onDelete(this)},ct.prototype.move=function(t){this.onMove(this,t)},ct.prototype.clone=function(){this.onCopy(this)},ct.prototype.select=function(t){t!==this.selectedField&&(null===t&&(t=this.fields[0]),this.selectedField&&this.selectedField.deselect(),this.selectedField=t,this.ui.toggleSelection(!0),this.onSelect(this))},ct.prototype.deselect=function(){this.selectedField=null,this.fields.forEach(function(t){t.deselect()}),this.ui.toggleSelection(!1),this.onDeselect(this)},ct.prototype.scrollTo=function(){var t=g.offset(this.ui.$editor).top-100;t=0<t?t:0},ct.prototype.getData=function(t){var e=[];this.fields.forEach(function(t){e.push(t.data)});var o={template:this.template.name,fields:e};return t||(o.html=this.getHtml(!0)),o},ct.prototype.getHtml=function(t){var e=g.el(this.template.$html.innerHTML),n={};this.fields.forEach(function(t){var e=t.name||t.data.name;n[e]=t.getEl()}),g.select(e,b.selectorField,!0).forEach(function(t){var e=g.data(t,"breField").name,o=n[e];g.replaceWith(t,o)});var o=e.outerHTML;return o?t?o.breTotalTrim():o:null},ct);function ct(t,e,o,n,i,r,l,s,a,c){var d=this;this.template=t,this.onDelete=n,this.onSelect=i,this.onDeselect=r,this.onCopy=l,this.onMove=s,this.onUpdate=a,this.onUpload=c,this.fields=[];var u=g.el(t.$html.innerHTML);this.bindFields(u,o);var h=this.getActions();this.ui=new lt(u,e,h,function(){return d.select()})}var dt=(ut.prototype.getData=function(e){var o=[];return this.blocks.forEach(function(t){o.push(t.getData(e))}),o},ut.prototype.getHtml=function(){var e=[];this.blocks.forEach(function(t){e.push(t.getHtml(!0))});var t=g.clone(this.$element);return t.innerHTML=e.join("\n"),t.outerHTML},ut.prototype.addBlock=function(t,e,o,n){var i=this;void 0===n&&(n=!0);var r=new at(t,!1,e,function(t){return i.deleteBlock(t)},function(t){return i.selectBlock(t)},function(t){return i.deselectBlock(t)},function(t){return i.copyBlock(t)},function(t,e){return i.moveBlock(t,e)},this.onUpdateBlock,this.onUpload);this.insertBlock(r,o),n&&(r.select(),r.scrollTo())},ut.prototype.insertBlock=function(t,e){e=e||this.blocks.length,this.selectedBlock&&(e=this.blocks.indexOf(this.selectedBlock)+1),this.blocks.splice(e,0,t),0==e?this.$element.appendChild(t.ui.$editor):g.after(this.blocks[e-1].ui.$editor,t.ui.$editor),this.onAddBlock(t,e),t.select(null),this.togglePlaceholderIfNeed()},ut.prototype.deleteBlock=function(t){var e=this.blocks.indexOf(t);this.blocks.splice(e,1),t=null,e<this.blocks.length?this.blocks[e].select():0<this.blocks.length?this.blocks[e-1].select():this.selectedBlock=null,this.onDeleteBlock(t,e),this.togglePlaceholderIfNeed()},ut.prototype.moveBlock=function(t,e){var o=this.blocks.indexOf(t),n=o+e;if(!(n>=this.blocks.length||n<0)){var i=this.blocks[n].ui.$editor;0<e?g.after(i,t.ui.$editor):e<0&&g.before(i,t.ui.$editor),this.blocks.splice(o,1),this.blocks.splice(n,0,t),this.onMoveBlock(t,o,n),t.scrollTo()}},ut.prototype.copyBlock=function(t){var e=this.blocks.indexOf(t)+1;this.addBlock(t.template,t.getData().fields,e,!0)},ut.prototype.selectBlock=function(t){this.selectedBlock!==t&&(this.selectedBlock&&this.selectedBlock.deselect(),this.selectedBlock=t,this.onSelectBlock(t))},ut.prototype.deselectBlock=function(t){this.selectedBlock=null,this.onDeselectBlock(t)},ut.prototype.togglePlaceholderIfNeed=function(){this.usePlaceholder&&(0===this.blocks.length?this.$placeholder||(this.$placeholder=g.el('<i data-bre-placeholder="true">Click here to select this container...</i>'),this.$element.appendChild(this.$placeholder)):this.$placeholder&&(this.$placeholder.remove(),this.$placeholder=null))},ut);function ut(t,e,o,n,i,r,l,s,a){void 0===a&&(a=!1),this.$element=t,this.onAddBlock=e,this.onDeleteBlock=o,this.onSelectBlock=n,this.onDeselectBlock=i,this.onMoveBlock=r,this.onUpdateBlock=l,this.onUpload=s,this.usePlaceholder=a,this.blocks=[],this.isContainer=!0,this.togglePlaceholderIfNeed()}var ht=(pt.onLoad="onLoad",pt.onChange="onChange",pt.onBlockAdd="onBlockAdd",pt.onBlockDelete="onBlockDelete",pt.onBlockMove="onBlockMove",pt.onBlockSelect="onBlockSelect",pt.onBlockDeselect="onBlockDeselect",pt.onBlockUpdate="onBlockUpdate",pt);function pt(){}var ft=function(t){this.templatesUrl="templates/bootstrap4.html",this.onError=function(t){console.log(t.message)},this.compactTools=null,this.compactToolsWidth=768,this.ignoreHtml=null,this.htmlToolsButtons=null,this.templatesUrl=t.templatesUrl||this.templatesUrl,this.onLoad=t.onLoad||t.onload,this.onChange=t.onChange,this.onBlockAdd=t.onBlockAdd,this.onBlockDelete=t.onBlockDelete,this.onBlockMove=t.onBlockMove,this.onBlockSelect=t.onBlockSelect,this.onBlockDeselect=t.onBlockDeselect,this.onBlockUpdate=t.onBlockUpdate,this.onError=t.onError||this.onError,this.onUpload=t.onUpload||null,this.blocksUrl=t.blocksUrl||null,this.blocks=t.blocks||null,this.compactTools=t.compactTools,this.ignoreHtml=t.ignoreHtml||!1,this.htmlToolsButtons=t.htmlToolsButtons||null,this.formSelector=t.formSelector||null,this.inputSelector=t.inputSelector||null},mt=(gt.prototype.createContainer=function(){var i=this;return new dt(this.$editor,function(t,e){i.isLoaded&&(i.trigger(ht.onBlockAdd,{block:t,idx:e}),i.trigger(ht.onChange,{blocks:i.getData(),html:i.getHtml()}))},function(t,e){i.trigger(ht.onBlockDelete,{block:t,idx:e}),i.trigger(ht.onChange,{blocks:i.getData(),html:i.getHtml()})},function(t){i.trigger(ht.onBlockSelect,{block:t})},function(t){i.trigger(ht.onBlockDeselect,{block:t})},function(t,e,o){i.trigger(ht.onBlockMove,{block:t,from:e,to:o}),i.trigger(ht.onChange,{blocks:i.getData(),html:i.getHtml()})},function(t,e,o,n){i.trigger(ht.onBlockUpdate,{block:t,property:e,oldValue:o,newValue:n}),i.trigger(ht.onChange,{blocks:i.getData(),html:i.getHtml()})},this.options.onUpload)},gt.prototype.initAsync=function(){return f(this,void 0,void 0,function(){var e,o,n;return m(this,function(t){switch(t.label){case 0:return e=this,gt.UI.toggleToolsLoader(!0),[4,O.loadTemplatesAsync(e.options.templatesUrl,e.$editor,e.onError)];case 1:return o=t.sent(),gt.UI.toggleToolsLoader(!1),gt.UI.setTemplates(o),[4,this.tryLoadInitialBlocksAsync()];case 2:return n=t.sent(),this.loadBlocks(n),this.isLoaded=!0,this.trigger(ht.onLoad,this),[2]}})})},gt.prototype.tryLoadInitialBlocksAsync=function(){return f(this,void 0,Promise,function(){var r,l,e=this;return m(this,function(t){return r=this.options.blocksUrl,l=this,[2,new Promise(function(n,i){return f(e,void 0,void 0,function(){var e,o;return m(this,function(t){switch(t.label){case 0:if(!r)return[3,5];t.label=1;case 1:return t.trys.push([1,3,,4]),[4,v.get(r)];case 2:return e=t.sent(),n(e),[3,4];case 3:return o=t.sent(),l.onError(y.errorBlocksFileNotFound(r)),i(o),[3,4];case 4:return[3,6];case 5:this.options.blocks?n(this.options.blocks):n(null),t.label=6;case 6:return[2]}})})})]})})},gt.prototype.tryBindFormSubmit=function(){var t=this,e=this.options.formSelector?g.find(this.options.formSelector):null,o=this.options.inputSelector?g.find(this.options.inputSelector):null;e&&o&&o instanceof HTMLInputElement&&g.on(e,"submit",function(){return o.value=JSON.stringify(t.getData()),!0})},gt.prototype.getData=function(){return this.container.getData(this.options.ignoreHtml)},gt.prototype.getHtml=function(){return this.container.getHtml()},gt.prototype.loadBlocks=function(t){var n=this;t&&t.length&&t.forEach(function(t){var e=O.getTemplate(t.template);if(e)n.container.addBlock(e,t.fields,null,!1);else{var o=y.errorBlockTemplateNotFound(t.template);n.onError(o)}})},gt.prototype.addBlock=function(t){this.getContainer(this.container).addBlock(t,null,null,!0)},gt.prototype.getContainer=function(t){if(t.selectedBlock&&t.selectedBlock.isContainer()){var e=t.selectedBlock.selectedField;if(e)return this.getContainer(e.container)}return t},gt.prototype.trigger=function(o,n){g.trigger(this.$editor,"bre."+o,n),d.propsEach(this.options,function(t,e){t.breEqualsInvariant(o)&&e&&e(n)})},gt);function gt(t,e){var o=this;this.onError=function(t,e){return void 0===e&&(e=0),o.options.onError({message:t,code:e})},a.registerCommonFields(),this.$editor=t,this.$editor.classList.add(b.classEditor),this.options=new ft(e),this.container=this.createContainer(),gt.UI=new it(this),this.tryBindFormSubmit()}return t.Editor=mt,t}({});
